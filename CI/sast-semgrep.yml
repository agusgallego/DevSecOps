steps:
  - script: |
      echo "[INFO] Iniciando escaneo SAST con Semgrep..."
      if [ -f "$(System.DefaultWorkingDirectory)/security/.semgrepignore" ]; then
          echo ">>> [CONFIG] Aplicando excepciones desde security/.semgrepignore"
          cp $(System.DefaultWorkingDirectory)/security/.semgrepignore .semgrepignore
      fi
      
      docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep scan \
        --config=p/security-audit \
        --config=p/owasp-top-ten \
        --config=p/secrets \
        --sarif --output report.sarif \
        --error 
        
    displayName: 'SAST Scan (Semgrep)'
    continueOnError: true 

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Semgrep Report'
    condition: always()
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)/report.sarif'
      ArtifactName: 'CodeAnalysisLogs'
      publishLocation: 'Container'