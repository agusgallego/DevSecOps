parameters:
  - name: imageName
    type: string
  - name: breakBuild
    type: boolean
    default: false

steps:
  - script: |
      echo ">>> [INFO] Buscando Dockerfile dinámicamente..."
      DF_PATH=$(find $(System.DefaultWorkingDirectory) -name "Dockerfile" -not -path "*/Templates/*" -print -quit)
      
      if [ -z "$DF_PATH" ]; then
        echo "##vso[task.logissue type=error]CRÍTICO: No se encontró ningún Dockerfile."
        exit 1
      fi
      
      DF_DIR=$(dirname "$DF_PATH")
      echo "##vso[task.setvariable variable=autoDockerfilePath]$DF_PATH"
      echo "##vso[task.setvariable variable=autoBuildContext]$DF_DIR"
    displayName: ' Auto-Detect Context'

  - task: Docker@2
    displayName: ' Build Local Image'
    inputs:
      command: build
      repository: ${{ split(parameters.imageName, ':')[0] }}
      tags: ${{ split(parameters.imageName, ':')[1] }}
      Dockerfile: '$(autoDockerfilePath)'
      buildContext: '$(autoBuildContext)'

  - script: |
      echo "Analizando sintaxis..."
      # Generamos el reporte directamente en el directorio de staging para no tener que moverlo luego
      # || true evita que el pipeline falle si hay warnings
      docker run --rm -v "$(autoBuildContext)":/data -w /data \
        hadolint/hadolint hadolint --format sarif Dockerfile > $(System.DefaultWorkingDirectory)/hadolint.sarif || true
    displayName: ' Hadolint (Dockerfile Lint)'
    continueOnError: true

  - script: |
      echo "Escaneando IaC..."
      docker run --rm -v "$(autoBuildContext)":/src aquasec/trivy:latest \
        config --format sarif --output /src/trivy-iac.sarif /src/ || true
      
      if [ -f "$(autoBuildContext)/trivy-iac.sarif" ]; then
          mv "$(autoBuildContext)/trivy-iac.sarif" $(System.DefaultWorkingDirectory)/trivy-iac.sarif
      fi
    displayName: ' Trivy (IaC - Compose & Dockerfile)'
    continueOnError: true

  - script: |
      echo "Escaneando imagen..."
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v $(System.DefaultWorkingDirectory):/output \
        aquasec/trivy:latest image \
        --format sarif \
        --output /output/trivy-image.sarif \
        --severity HIGH,CRITICAL \
        --scanners vuln,secret \
        --ignore-unfixed \
        ${{ parameters.imageName }} || true
    displayName: ' Trivy (Image Vulns & Secrets)'
    continueOnError: true 

  - bash: |
      echo ">>> Organizando reportes para publicación..."
      mkdir -p $(Build.ArtifactStagingDirectory)/SecurityReports
      
      find $(System.DefaultWorkingDirectory) -maxdepth 1 -name "*.sarif" -exec mv {} $(Build.ArtifactStagingDirectory)/SecurityReports/ \;
      
      echo ">>> Contenido a publicar:"
      ls -la $(Build.ArtifactStagingDirectory)/SecurityReports/
    displayName: ' Prepare Artifacts'
    condition: always()

  - task: PublishBuildArtifacts@1
    displayName: ' Publish Security Reports'
    condition: always()
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/SecurityReports'
      ArtifactName: 'CodeAnalysisLogs'
      publishLocation: 'Container'