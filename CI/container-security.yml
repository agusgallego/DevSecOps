parameters:
  - name: imageName
    type: string
  - name: breakBuild
    type: boolean
    default: false

steps:
  - script: |
      echo ">>> [INFO] Localizando Dockerfile..."
      DF_PATH=$(find $(System.DefaultWorkingDirectory) -name "Dockerfile" -not -path "*/Templates/*" -print -quit)
      if [ -z "$DF_PATH" ]; then exit 1; fi
      DF_DIR=$(dirname "$DF_PATH")
      echo "##vso[task.setvariable variable=autoBuildContext]$DF_DIR"
    displayName: 'Detectar Contexto'

  - script: |
      echo ">>> [INFO] Iniciando Hadolint..."
      HADOLINT_ARGS=""
      if [ -f "$(System.DefaultWorkingDirectory)/security/.hadolint.yaml" ]; then
          echo ">>> [CONFIG] Usando configuraciÃ³n personalizada desde security/.hadolint.yaml"
          cp $(System.DefaultWorkingDirectory)/security/.hadolint.yaml $(autoBuildContext)/.hadolint.yaml
          HADOLINT_ARGS="--config .hadolint.yaml"
      fi

      docker run --rm -v "$(autoBuildContext)":/data -w /data \
        hadolint/hadolint hadolint --format sarif $HADOLINT_ARGS Dockerfile > $(System.DefaultWorkingDirectory)/hadolint.sarif || true
    displayName: 'Hadolint Audit'

  - script: |
      docker run --rm -v "$(System.DefaultWorkingDirectory)":/src aquasec/trivy:latest \
        config --format sarif --output /src/trivy-iac.sarif /src/ || true
    displayName: 'Trivy IaC Audit'

  - script: |
      EXIT_CODE=0
      if [ "${{ parameters.breakBuild }}" == "True" ]; then EXIT_CODE=1; fi
      TRIVY_ARGS=""
      if [ -f "$(System.DefaultWorkingDirectory)/security/.trivyignore" ]; then
          echo ">>> [CONFIG] Usando excepciones desde security/.trivyignore"
          TRIVY_ARGS="--ignorefile /output/security/.trivyignore"
      fi

      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v $(System.DefaultWorkingDirectory):/output \
        aquasec/trivy:latest image \
        --format sarif --output /output/trivy-image.sarif \
        $TRIVY_ARGS \
        --severity MEDIUM,HIGH,CRITICAL --exit-code $EXIT_CODE ${{ parameters.imageName }}
    displayName: 'Trivy Image Audit'