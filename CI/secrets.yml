steps:
  - script: |
      echo "[INFO] Iniciando escaneo de secretos con GitLeaks..."
      
      # Validación de archivo de ignore
      IGNORE_PATH="${{ parameters.configFile }}"
      if [ ! -f "$IGNORE_PATH" ]; then
        touch .gitleaksignore_temp
        IGNORE_PATH=".gitleaksignore_temp"
      fi

      # Ejecución de Gitleaks
      docker run --rm -v $(pwd):/path zricethezav/gitleaks:latest detect \
        --source="/path" \
        --gitleaks-ignore-path="/path/$IGNORE_PATH" \
        --report-format="sarif" \
        --report-path="/path/gitleaks-report.sarif" \
        --no-git
    displayName: 'Scan for Secrets (Gitleaks)'
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Secrets SARIF'
    condition: always()
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)/gitleaks-report.sarif'
      ArtifactName: 'CodeAnalysisLogs'
      publishLocation: 'Container'