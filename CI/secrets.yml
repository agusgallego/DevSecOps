parameters:
  - name: configFile
    type: string
    default: '.gitleaksignore'  
  - name: workingDirectory
    type: string
    default: '$(System.DefaultWorkingDirectory)'

steps:
  - script: |
      echo "[INFO] Iniciando escaneo de secretos con GitLeaks..."

      IGNORE_FILE="${{ parameters.configFile }}"

      if [ ! -f "${{ parameters.workingDirectory }}/$IGNORE_FILE" ]; then
        echo "[WARN] No se encontró el archivo $IGNORE_FILE. Se usará configuración por defecto."

        touch "${{ parameters.workingDirectory }}/.gitleaksignore_temp"
        IGNORE_FILE=".gitleaksignore_temp"
      else
        echo "[INFO] Usando archivo de exclusiones: $IGNORE_FILE"
      fi

      docker run --rm \
        -v "${{ parameters.workingDirectory }}":/path \
        zricethezav/gitleaks:latest detect \
        --source="/path" \
        --gitleaks-ignore-path="/path/$IGNORE_FILE" \
        --report-format="sarif" \
        --report-path="/path/gitleaks-report.sarif" \
        --no-git \
        --verbose

    displayName: 'Scan for Secrets (Gitleaks)'
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Secrets SARIF'
    condition: always()
    inputs:
      PathtoPublish: '${{ parameters.workingDirectory }}/gitleaks-report.sarif'
      ArtifactName: 'CodeAnalysisLogs'
      publishLocation: 'Container'