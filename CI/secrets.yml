parameters:
  - name: configFile
    type: string
    default: '.gitleaksignore' 
  - name: workingDirectory
    type: string
    default: '$(System.DefaultWorkingDirectory)'

steps:
  - script: |
      echo "[INFO] Iniciando escaneo de secretos con GitLeaks..."
      
      if [ -f "${{ parameters.workingDirectory }}/security/.gitleaksignore" ]; then
          echo ">>> [CONFIG] Encontrado security/.gitleaksignore. Copiando a raíz..."
          cp "${{ parameters.workingDirectory }}/security/.gitleaksignore" "${{ parameters.workingDirectory }}/.gitleaksignore"
          IGNORE_FILE=".gitleaksignore"
      
      elif [ -f "${{ parameters.workingDirectory }}/${{ parameters.configFile }}" ]; then
          echo ">>> [CONFIG] Usando archivo parametrizado: ${{ parameters.configFile }}"
          IGNORE_FILE="${{ parameters.configFile }}"
      
      else
          echo "[WARN] No se encontró archivo de excepciones. Usando configuración por defecto."
          touch "${{ parameters.workingDirectory }}/.gitleaksignore_temp"
          IGNORE_FILE=".gitleaksignore_temp"
      fi
      docker run --rm \
        -v "${{ parameters.workingDirectory }}":/path \
        zricethezav/gitleaks:latest detect \
        --source="/path" \
        --gitleaks-ignore-path="/path/$IGNORE_FILE" \
        --report-format="sarif" \
        --report-path="/path/gitleaks-report.sarif" \
        --no-git \
        --verbose

    displayName: 'Scan for Secrets (Gitleaks)'
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Secrets SARIF'
    condition: always()
    inputs:
      PathtoPublish: '${{ parameters.workingDirectory }}/gitleaks-report.sarif'
      ArtifactName: 'CodeAnalysisLogs'
      publishLocation: 'Container'
